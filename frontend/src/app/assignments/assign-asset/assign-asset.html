<div class="assign-container">
  <h2>Assign Assets</h2>
  <form [formGroup]="assignmentForm" (ngSubmit)="onSubmit()">

    <!-- Employee + IT Staff -->
    <div class="row">
      <!-- Employee Autocomplete -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select Employee</mat-label>
        <input type="text" matInput [matAutocomplete]="empAuto" [(ngModel)]="employeeSearch"
          (ngModelChange)="filterEmployees()" formControlName="emp_code" required />
        <mat-autocomplete #empAuto="matAutocomplete" [displayWith]="displayEmp.bind(this)">
          <mat-option *ngFor="let emp of filteredEmployees" [value]="emp.emp_code">
            {{ emp.name }} ({{ emp.emp_code }})
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>


      <!-- Assigned By (Auto-filled) -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Assigned By</mat-label>
        <input matInput formControlName="assigned_by" readonly />
      </mat-form-field>

    </div>

    <!-- PSD ID -->
    <div class="row">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>PSD ID (Ticket Reference)</mat-label>
        <input matInput formControlName="psd_id" placeholder="Enter PSD / Ticket ID" required />
      </mat-form-field>
    </div>

    <!-- Asset Rows -->
    <div formArrayName="assignments">
      <div *ngFor="let a of assignments.controls; let i = index" [formGroupName]="i" class="assignment-row">

        <div class="row">
          <!-- Asset Type Autocomplete -->
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Asset Type</mat-label>
            <input type="text" matInput [matAutocomplete]="assetAuto" [(ngModel)]="assetTypeSearch[i]"
              (ngModelChange)="filterAssetTypes(i)" formControlName="asset_type" required />
            <mat-autocomplete #assetAuto="matAutocomplete" (optionSelected)="onAssetTypeChange(i)">
              <mat-option *ngFor="let t of filteredAssetTypes[i]" [value]="t">{{ t }}</mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <!-- Cable Type Autocomplete (if cables) -->
          <mat-form-field *ngIf="isCables(i)" appearance="outline" class="row-field">
            <mat-label>Cable Type</mat-label>
            <input type="text" matInput [matAutocomplete]="cableAuto" [(ngModel)]="cableTypeSearch[i]"
              (ngModelChange)="filterCableTypes(i)" formControlName="cable_type" required />
            <mat-autocomplete #cableAuto="matAutocomplete" (optionSelected)="onCableTypeChange(i)">
              <mat-option *ngFor="let c of filteredCableTypes[i]" [value]="c">{{ c }}</mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <!-- Asset Code for cables -->
          <mat-form-field *ngIf="isCables(i)" appearance="outline" class="row-field">
            <mat-label>Asset Code</mat-label>
            <mat-select formControlName="asset_code" required>
              <mat-option *ngFor="let cable of availableCables" [value]="cable.asset_code">
                {{ cable.asset_code }} ({{ cable.serial_number }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Asset Code for non-cables -->
          <mat-form-field *ngIf="!isCables(i)" appearance="outline" class="row-field">
            <mat-label>Asset Code</mat-label>
            <input matInput formControlName="asset_code" (blur)="onAssetCodeBlur(i)" required />
            <mat-error *ngIf="assignments.at(i).get('asset_code')?.hasError('assigned')">
              ⚠️ This asset is already assigned.
            </mat-error>
          </mat-form-field>

          <!-- Serial Number -->
          <mat-form-field appearance="outline" class="row-field" *ngIf="!isCables(i)">
            <mat-label>Serial Number</mat-label>
            <input matInput formControlName="serial_number" />
          </mat-form-field>
        </div>

        <!-- Brand / Processor / Charger -->
        <div class="row" *ngIf="!isCables(i)">
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Brand</mat-label>
            <input matInput formControlName="asset_brand" />
          </mat-form-field>

          <mat-form-field *ngIf="isLaptopOrDesktop(i)" appearance="outline" class="row-field">
            <mat-label>Processor</mat-label>
            <input matInput formControlName="processor" />
          </mat-form-field>

          <mat-form-field *ngIf="hasCharger(i)" appearance="outline" class="row-field">
            <mat-label>Charger Serial Number</mat-label>
            <input matInput formControlName="charger_serial" />
            <mat-error *ngIf="assignments.at(i).get('charger_serial')?.hasError('assigned')">
              ⚠️ This charger is already assigned.
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Warranty Dates -->
        <div class="row" *ngIf="!isCables(i)">
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Warranty Start</mat-label>
            <input matInput [matDatepicker]="ws" formControlName="warranty_start" />
            <mat-datepicker-toggle matSuffix [for]="ws"></mat-datepicker-toggle>
            <mat-datepicker #ws></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Warranty End</mat-label>
            <input matInput [matDatepicker]="we" formControlName="warranty_end" />
            <mat-datepicker-toggle matSuffix [for]="we"></mat-datepicker-toggle>
            <mat-datepicker #we></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Assign Date / Remark -->
        <div class="row">
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Assign Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="assign_date" required />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Remark</mat-label>
            <input matInput formControlName="assign_remark" />
          </mat-form-field>

          <button mat-icon-button color="warn" (click)="removeAssignment(i)" *ngIf="assignments.length > 1">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <mat-divider></mat-divider>
      </div>
    </div>

    <div class="actions">
      <button *ngIf="authService.getRole() === 'IT'" mat-button color="primary" type="button" (click)="addAssignment()">
        <mat-icon>add</mat-icon> Add Another Asset
      </button>

      <button *ngIf="authService.getRole() === 'IT'" mat-raised-button color="primary" type="submit">
        <mat-icon>send</mat-icon> Assign Assets
      </button>

    </div>
  </form>
</div>