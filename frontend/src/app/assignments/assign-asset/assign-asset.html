<div class="assign-container">
  <h2>Assign Assets</h2>
  <form [formGroup]="assignmentForm" (ngSubmit)="onSubmit()">

    <!-- Employee + IT Staff -->
    <div class="row">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select Employee</mat-label>
        <mat-select formControlName="emp_code" required>
          <mat-option *ngFor="let emp of employees" [value]="emp.emp_code">
            {{ emp.name }} ({{ emp.emp_code }})
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Assigned By (IT Staff)</mat-label>
        <mat-select formControlName="assigned_by" required>
          <mat-option *ngFor="let it of itPersons" [value]="it.emp_code">
            {{ it.name }} ({{ it.emp_code }})
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- PSD ID -->
    <div class="row">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>PSD ID (Ticket Reference)</mat-label>
        <input matInput formControlName="psd_id" placeholder="Enter PSD / Ticket ID" required />
      </mat-form-field>
    </div>

    <!-- Asset Rows -->
    <div formArrayName="assignments">
      <div *ngFor="let a of assignments.controls; let i = index" [formGroupName]="i" class="assignment-row">

        <div class="row">
          <!-- Asset Type -->
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Asset Type</mat-label>
            <mat-select formControlName="asset_type" required>
              <mat-option *ngFor="let t of assetTypes" [value]="t">{{ t }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Cable Type -->
          <mat-form-field *ngIf="isCables(i)" appearance="outline" class="row-field">
            <mat-label>Cable Type</mat-label>
            <mat-select formControlName="cable_type" (selectionChange)="onCableTypeChange(i)" required>
              <mat-option *ngFor="let c of cableTypes" [value]="c">{{ c }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Asset Code -->
          <mat-form-field *ngIf="isCables(i)" appearance="outline" class="row-field">
            <mat-label>Asset Code</mat-label>
            <mat-select formControlName="asset_code" required>
              <mat-option *ngFor="let cable of availableCables" [value]="cable.asset_code">
                {{ cable.asset_code }} ({{ cable.serial_number }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field *ngIf="!isCables(i)" appearance="outline" class="row-field">
            <mat-label>Asset Code</mat-label>
            <input matInput formControlName="asset_code" (blur)="onAssetCodeBlur(i)" required />
          </mat-form-field>

          <!-- Serial Number -->
          <mat-form-field appearance="outline" class="row-field" *ngIf="!isCables(i)">
            <mat-label>Serial Number</mat-label>
            <input matInput formControlName="serial_number" [required]="a.get('isNew')?.value" />
          </mat-form-field>
        </div>

        <!-- Brand / Processor / Charger -->
        <div class="row" *ngIf="!isCables(i)">
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Brand</mat-label>
            <input matInput formControlName="asset_brand" />
          </mat-form-field>

          <mat-form-field *ngIf="isLaptopOrDesktop(i)" appearance="outline" class="row-field">
            <mat-label>Processor</mat-label>
            <input matInput formControlName="processor" [required]="a.get('isNew')?.value" />
          </mat-form-field>

          <mat-form-field *ngIf="hasCharger(i)" appearance="outline" class="row-field">
            <mat-label>Charger Serial Number</mat-label>
            <input matInput formControlName="charger_serial" [required]="a.get('isNew')?.value" />
          </mat-form-field>
        </div>

        <!-- Warranty Dates (hidden for cables) -->
        <div class="row" *ngIf="!isCables(i)">
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Warranty Start</mat-label>
            <input matInput [matDatepicker]="ws" formControlName="warranty_start" [required]="a.get('isNew')?.value" />
            <mat-datepicker-toggle matSuffix [for]="ws"></mat-datepicker-toggle>
            <mat-datepicker #ws></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Warranty End</mat-label>
            <input matInput [matDatepicker]="we" formControlName="warranty_end" [required]="a.get('isNew')?.value" />
            <mat-datepicker-toggle matSuffix [for]="we"></mat-datepicker-toggle>
            <mat-datepicker #we></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Assign Date / Remark -->
        <div class="row">
          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Assign Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="assign_date" required />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="row-field">
            <mat-label>Remark</mat-label>
            <input matInput formControlName="assign_remark" />
          </mat-form-field>

          <button mat-icon-button color="warn" (click)="removeAssignment(i)" *ngIf="assignments.length > 1">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <mat-divider></mat-divider>
      </div>
    </div>

    <div class="actions">
      <button mat-button color="primary" type="button" (click)="addAssignment()">
        <mat-icon>add</mat-icon> Add Another Asset
      </button>
      <button mat-raised-button color="primary" type="submit">
        <mat-icon>send</mat-icon> Assign Assets
      </button>
    </div>
  </form>
</div>
